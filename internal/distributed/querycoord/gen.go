//go:build ignore
// +build ignore

package main

import (
	"fmt"
	"os"
	"text/template"
	"time"
)

//go:generate go run gen.go

var methodTemplate = template.Must(template.New("").Parse(`// Code generated by go generate; DO NOT EDIT
// This file is generated by go generate at {{ .Timestamp }}

// Licensed to the LF AI & Data foundation under one
// or more contributor license agreements. See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership. The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License. You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package grpcquerycoord

import (
	"context"
	"errors"
	"strings"
	"time"

	"github.com/milvus-io/milvus-proto/go-api/commonpb"
	"github.com/milvus-io/milvus-proto/go-api/milvuspb"
	"github.com/milvus-io/milvus/internal/proto/internalpb"
	"github.com/milvus-io/milvus/internal/proto/querypb"
	"github.com/milvus-io/milvus/internal/util/errorutil"
	"github.com/milvus-io/milvus/internal/util/retry"
)
{{ range .Methods }}{{with .}}
// {{.MethodComment}}
func (s *Server) {{.MethodName}}(ctx context.Context, request {{.RequestType}}) ({{.ResponseType}}, error) {
	var resp {{.ResponseType}}
	var err error
	retry.Do(ctx, func() error {
		{{- if .SkipRequestParam}}
		resp, err = s.queryCoord.{{.MethodName}}(ctx)
		{{- else}}
		resp, err = s.queryCoord.{{.MethodName}}(ctx, request)
		{{- end}}
		{{- if eq .ResponseType "*commonpb.Status"}}
		if err == nil &&
			resp.GetErrorCode() == commonpb.ErrorCode_UnexpectedError &&
			strings.Contains(strings.ToLower(resp.GetReason()), errorutil.StandbyStateReason) {
		{{- else}}
		if err == nil &&
			resp.GetStatus().GetErrorCode() == commonpb.ErrorCode_UnexpectedError &&
			strings.Contains(strings.ToLower(resp.GetStatus().GetReason()), errorutil.StandbyStateReason) {
		{{- end}}
			return errors.New("queryCoord is switching from standby to active mode, retry request")
		} else {
			return nil
		}
	}, retry.Attempts(600), retry.Sleep(time.Millisecond*500), retry.MaxSleepTime(5*time.Second))
	return resp, err
}
{{end}}{{end}}`))

type methodDef struct {
	MethodName       string
	RequestType      string
	ResponseType     string
	MethodComment    string
	SkipRequestParam bool
}

func main() {
	f, err := os.OpenFile("service_impl.go", os.O_RDWR|os.O_CREATE|os.O_TRUNC, 0755)
	if err != nil {
		fmt.Println(err.Error())
		os.Exit(1)
	}
	defer f.Close()

	settings := struct {
		Timestamp time.Time
		Methods   []methodDef
	}{
		Timestamp: time.Now(),
		Methods: []methodDef{
			{
				"ShowCollections", "*querypb.ShowCollectionsRequest", "*querypb.ShowCollectionsResponse", "ShowCollections shows the collections in the QueryCoord", false,
			},
			{
				"LoadCollection", "*querypb.LoadCollectionRequest", "*commonpb.Status", "LoadCollection loads the data of the specified collection in QueryCoord", false,
			},
			{
				"ReleaseCollection", "*querypb.ReleaseCollectionRequest", "*commonpb.Status", "ReleaseCollection releases the data of the specified collection in QueryCoord", false,
			},
			{
				"ShowPartitions", "*querypb.ShowPartitionsRequest", "*querypb.ShowPartitionsResponse", "ShowPartitions shows the partitions in the QueryCoord", false,
			},
			{
				"GetPartitionStates", "*querypb.GetPartitionStatesRequest", "*querypb.GetPartitionStatesResponse", "GetPartitionStates gets the states of the specified partition", false,
			},
			{
				"LoadPartitions", "*querypb.LoadPartitionsRequest", "*commonpb.Status", "LoadPartitions loads the data of the specified partition in QueryCoord", false,
			},
			{
				"ReleasePartitions", "*querypb.ReleasePartitionsRequest", "*commonpb.Status", "ReleasePartitions releases the data of the specified partition in QueryCoord", false,
			},
			{
				"GetSegmentInfo", "*querypb.GetSegmentInfoRequest", "*querypb.GetSegmentInfoResponse", "GetSegmentInfo gets the information of the specified segment from QueryCoord", false,
			},
			{
				"LoadBalance", "*querypb.LoadBalanceRequest", "*commonpb.Status", "LoadBalance migrate the sealed segments on the source node to the dst nodes", false,
			},
			{
				"ShowConfigurations", "*internalpb.ShowConfigurationsRequest", "*internalpb.ShowConfigurationsResponse", "ShowConfigurations gets specified configurations para of QueryCoord", false,
			},
			{
				"GetMetrics", "*milvuspb.GetMetricsRequest", "*milvuspb.GetMetricsResponse", "GetMetrics gets the metrics information of QueryCoord", false,
			},
			{
				"GetReplicas", "*milvuspb.GetReplicasRequest", "*milvuspb.GetReplicasResponse", "GetReplicas returns the shard leaders of a certain collection", false,
			},
			{
				"GetShardLeaders", "*querypb.GetShardLeadersRequest", "*querypb.GetShardLeadersResponse", "GetShardLeaders returns the shard leaders of a certain collection", false,
			},
			{
				"CreateResourceGroup", "*milvuspb.CreateResourceGroupRequest", "*commonpb.Status", "CreateResourceGroup", false,
			},
			{
				"DropResourceGroup", "*milvuspb.DropResourceGroupRequest", "*commonpb.Status", "DropResourceGroup", false,
			},
			{
				"TransferNode", "*milvuspb.TransferNodeRequest", "*commonpb.Status", "TransferNode", false,
			},
			{
				"TransferReplica", "*querypb.TransferReplicaRequest", "*commonpb.Status", "TransferReplica", false,
			},
			{
				"ListResourceGroups", "*milvuspb.ListResourceGroupsRequest", "*milvuspb.ListResourceGroupsResponse", "ListResourceGroups", false,
			},
			{
				"DescribeResourceGroup", "*querypb.DescribeResourceGroupRequest", "*querypb.DescribeResourceGroupResponse", "DescribeResourceGroup", false,
			},
		},
	}
	methodTemplate.Execute(f, settings)
}
